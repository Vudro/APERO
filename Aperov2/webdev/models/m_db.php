<?php// MODELclass MainModel extends PDO{    private $arr_executed_sql = [];    function __construct()    {        parent::__construct('mysql:host=' . DB_HOST . ';port=3306;dbname=' . DB_NAME . ';charset=UTF8;', DB_LOGIN, DB_PASS);        $this->query('SET NAMES utf8;');    }    function execQuery($request)    {        $rest = $this->query($request)->fetchAll(PDO::FETCH_ASSOC);        $this->arr_executed_sql[] = $request;        return $rest;    }    function execInsert($request)    {        $rest = $this->exec($request);        $this->arr_executed_sql[] = $request;        return $rest;    }    function getLastQuery()    {        return end($this->arr_executed_sql);    }    function afficherEnfantFamille()    {        return $this->execQuery('SELECT Enfants.PrenomEnfant, Famille.NomFamille, Famille.AdresseFamille FROM Famille INNER JOIN Enfants ON Famille.IdFamille = Enfants.IdFamille;');    }    function afficherEnfant()    {        return $this->execQuery('SELECT * FROM enfant WHERE idfamille IS NULL;');    }    function afficherEtablissement()    {        return $this->execQuery('SELECT * FROM etablissement;');    }    function afficherLivreClasse()    {        return $this->execQuery('SELECT * FROM livre;');    }    function afficherMatiere()    {        return $this->execQuery('SELECT * FROM matiere;');    }    function afficherClasse()    {        return $this->execQuery('SELECT DISTINCT niveauclasse FROM classe;');    }    function afficherSection()    {        return $this->execQuery('SELECT DISTINCT section FROM classe;');    }    function afficherLivre()    {        return $this->execQuery('SELECT * FROM livre;');    }    function exemplaireFamille($nomLivre, $nomEtat, $familleVente)    {        $nomLivre = $this->quote($nomLivre);        $nomEtat = $this->quote($nomEtat);        $familleVente = $this->quote($familleVente);        $test = $this->execQuery('select id_livre from livre where nomlivre='.$nomLivre.';');        $test2 = $this->execQuery('select idfamille from famille where nomfamille='.$familleVente.';');        $data=$test[0];        $idlivre=$data['id_livre'];        $data2=$test2[0];        $idfamille=$data2['idfamille'];        return $this->execQuery('INSERT INTO exemplaire(nometat, idfamille, id_livre,idfamille_acheter, exemplaireetat) VALUE ('.$nomEtat.', '.$idfamille.', '.$idlivre.',NULL, "en attente");');    }    function exemplaireVente()    {        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat NOT LIKE "Vendu";');    }    function exemplaireVente2($famille)    {        $famille=$this->quote($famille);        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat NOT LIKE "Vendu" AND nomfamille='.$famille.';');    }    function exemplaireVendu()    {        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat="Vendu";');    }    function exemplaireVendu2($famille)    {        $famille=$this->quote($famille);        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat="Vendu" AND nomfamille='.$famille.';');    }    function exemplaireAcheter()    {        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat="Vendu";');    }    function exemplaireAcheter2($famille)    {        $famille=$this->quote($famille);        return $this->execQuery('SELECT * FROM exemplaire e INNER JOIN famille f ON e.idfamille_acheter=f.idfamille INNER JOIN livre l ON e.id_livre=l.id_livre WHERE exemplaireetat="Vendu" AND nomfamille='.$famille.';');    }    function afficherFamille()    {        return $this->execQuery('SELECT * FROM famille;');    }    function afficherExemplaire()    {        return $this->execQuery('SELECT * FROM exemplaire;');    }    function afficherEtat()    {        return $this->execQuery('SELECT * FROM etat;');    }    function afficherEtatVente()    {        return $this->execQuery('select DISTINCT etat.nometat from etat INNER JOIN exemplaire on etat.nometat=exemplaire.nometat where idfamille_acheter is null;');    }    function familleVente()    {        return $this->execQuery('SELECT idfamille FROM exemplaire;');    }    function ajoutMatiere($matiere)    {        $matiere = $this->quote($matiere);        return $this->execInsert('INSERT INTO matiere(nommatiere) VALUES ('.$matiere.');');    }    function ajoutLivre($nomLivre, $editionLivre, $prixNeuf, $matiere)    {        $nomLivre = $this->quote($nomLivre);        $editionLivre = $this->quote($editionLivre);        $prixNeuf = $this->quote($prixNeuf);        $matiere = $this->quote($matiere);        return $this->execInsert('INSERT INTO livre(nommatiere, nomlivre, editionlivre, prixneuf) VALUES ('.$matiere.','.$nomLivre.', '.$editionLivre.', '.$prixNeuf.');');    }    function affecterLivre($nivClasse, $section, $etablissement, $nomlivre)    {        $nivClasse = $this->quote($nivClasse);        $section = $this->quote($section);        $etablissement = $this->quote($etablissement);        $nomlivre = $this->quote($nomlivre);        return $this->execInsert('UPDATE livre SET idc =(SELECT idc FROM classe                                   INNER JOIN etablissement ON classe.idetablissement=etablissement.idetablissement                                   WHERE niveauclasse='.$nivClasse.' AND section='.$section.' AND etablissement.nometablissement='.$etablissement.') WHERE nomlivre='.$nomlivre.';');    }    function ajoutEtablissement($etablissement)    {        $etablissement = $this->quote($etablissement);        return $this->execInsert('INSERT INTO etablissement(nometablissement) VALUES ('.$etablissement.');');    }    function ajoutFamille($nomFamille, $adresseFamille, $cpFamille, $telFamille, $mailFamille, $villeFamille)    {        $nomFamille = $this->quote($nomFamille);        $adresseFamille = $this->quote($adresseFamille);        $cpFamille = $this->quote($cpFamille);        $telFamille = $this->quote($telFamille);        $mailFamille = $this->quote($mailFamille);        $villeFamille = $this->quote($villeFamille);        return $this->execInsert('INSERT INTO famille(nomfamille, adressefamille, cpfamille, villefamille, telfamille, mailfamille) VALUES ('.$nomFamille.','.$adresseFamille.', '.$cpFamille.', '.$villeFamille.', '.$telFamille.', '.$mailFamille.');');    }    function afficherFamilleEnfant()    {        return $this->execQuery('SELECT * FROM famille INNER JOIN enfant ON famille.idfamille=enfant.idfamille ORDER BY nomfamille;');    }    function ajoutEnfant($nomEnfant, $prenomEnfant, $classe, $nivEnfant)    {        $nomEnfant = $this->quote($nomEnfant);        $prenomEnfant = $this->quote($prenomEnfant);        $classe = $this->quote($classe);        $nivEnfant = $this->quote($nivEnfant);        return $this->execInsert('INSERT INTO enfant(prenomenfant, classeenfant, nomenfant, niveauenfant) VALUES ('.$prenomEnfant.','.$classe.', '.$nomEnfant.', '.$nivEnfant.');');    }    function affecterEnfant($enfant, $famille)    {        $enfant = $this->quote($enfant);        $famille = $this->quote($famille);        return $this->execQuery('UPDATE enfant SET idfamille =(SELECT idfamille FROM famille WHERE nomfamille='.$famille.') WHERE nomenfant='.$enfant.';');    }    function ajoutClasse($classe, $section)    {        $classe = $this->quote($classe);        $section = $this->quote($section);        return $this->execInsert('INSERT INTO classe(niveauclasse, section) VALUES ('.$classe.', '.$section.');');    }    function afficherClasseAffecter()    {        return $this->execQuery('SELECT * FROM classe WHERE idetablissement IS NULL;');    }    function affecterClasse($etablissement, $classe, $section)    {        $etablissement = $this->quote($etablissement);        $classe = $this->quote($classe);        $section = $this->quote($section);        return $this->execQuery('UPDATE classe SET idetablissement =(SELECT idetablissement FROM etablissement WHERE nometablissement='.$etablissement.') WHERE niveauclasse='.$classe.' AND section='.$section.';');    }    function affecterExemplaire($familleAchat, $exemplaire, $decote)    {        $familleAchat = $this->quote($familleAchat);        $exemplaire = $this->quote($exemplaire);        $decote = $this->quote($decote);        return $this->execQuery('update exemplaire set idfamille_acheter = (SELECT idfamille from famille where nomfamille='.$familleAchat.') WHERE id_livre=(SELECT id_livre from livre WHERE nomlivre='.$exemplaire.') AND nometat='.$decote.' and idfamille_acheter is null limit 1 ;');    }    function affecterExemplaireSelect($familleAchat, $exemplaire, $decote)    {        $familleAchat = $this->quote($familleAchat);        $exemplaire = $this->quote($exemplaire);        $decote = $this->quote($decote);        return $this->execQuery('select * from exemplaire WHERE id_livre=(SELECT id_livre from livre WHERE nomlivre='.$exemplaire.') AND nometat='.$decote.' and idfamille_acheter is null limit 1 ;');    }    function afficherLivreAchat()    {        return $this->execQuery('SELECT * from livre INNER JOIN exemplaire on exemplaire.id_livre=livre.id_livre WHERE exemplaire.idfamille_acheter IS null AND exemplaireetat NOT LIKE "Vendu";');    }    function vendu()    {        return $this->execQuery('update exemplaire set exemplaireetat = "Vendu" where idfamille_acheter IS NOT NULL;');    }    function prixExemplaire($nomlivre, $nometat)    {        $nomlivre = $this->quote($nomlivre);        $nometat = $this->quote($nometat);        $test = $this->execQuery('select * from etat where nometat='.$nometat.';');        $test2 = $this->execQuery('select * from livre where nomlivre='.$nomlivre.';');        $data=$test[0];        $decote=$data['decote'];        $data2=$test2[0];        $prix=$data2['prixneuf'];        return ($prix-($decote*$prix));    }    function siAcheter($famille)    {        $famille = $this->quote($famille);        return $this->execQuery('select * from exemplaire INNER JOIN famille on famille.idfamille=exemplaire.idfamille_acheter WHERE nomfamille='.$famille.';');    }}